// sitemap.js
const fs = require('fs');
const path = require('path');

const DOMAIN = 'https://bloglovers.pk';

// Ø¢Ù¾ Ú©Û’ redirects Ø³Û’ ØªÙ…Ø§Ù… Ù†Ø¦Û’ URLs Ø¬Ù…Ø¹ Ú©Ø±ÛŒÚº
function extractUrlsFromRedirects() {
  const redirectsContent = fs.readFileSync('vercel.json', 'utf8');
  const vercelConfig = JSON.parse(redirectsContent);
  
  const urls = new Set();
  
  // Home page Ø§ÙˆØ± static ØµÙØ­Ø§Øª
  urls.add({ url: '/', priority: '1.0', changefreq: 'daily' });
  urls.add({ url: '/about.html', priority: '0.8', changefreq: 'monthly' });
  urls.add({ url: '/contact.html', priority: '0.7', changefreq: 'monthly' });
  
  // ØªÙ…Ø§Ù… redirects Ø³Û’ destinations Ø¬Ù…Ø¹ Ú©Ø±ÛŒÚº
  vercelConfig.redirects.forEach(redirect => {
    if (redirect.destination && !redirect.destination.startsWith('http')) {
      urls.add({ 
        url: redirect.destination, 
        priority: '0.7', 
        changefreq: 'weekly',
        lastmod: extractDateFromSource(redirect.source)
      });
    }
  });
  
  // Ø¢Ù¾ Ú©ÛŒ categories Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº
  const categories = [
    'alamaat-sughra', 'alamaat-kubra', 'islami-taleemat', 'azkar',
    'taleem', 'mazameen', 'english-adab', 'technology', 'kids',
    'aqwal', 'islami-sawalat', 'motivation', 'tareekh', 'shakhsiyat'
  ];
  
  categories.forEach(category => {
    urls.add({ 
      url: `/${category}`, 
      priority: '0.9', 
      changefreq: 'weekly'
    });
  });
  
  return Array.from(urls);
}

// ØªØ§Ø±ÛŒØ® extract Ú©Ø±Ù†Û’ Ú©Ø§ function
function extractDateFromSource(source) {
  const dateMatch = source.match(/\/(\d{4})\/(\d{2})\//);
  if (dateMatch) {
    return `${dateMatch[1]}-${dateMatch[2]}-01`;
  }
  return new Date().toISOString().split('T')[0];
}

// XML generate Ú©Ø±ÛŒÚº
function generateSitemap(urls) {
  let xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">`;

  urls.forEach(item => {
    const lastmod = item.lastmod || new Date().toISOString().split('T')[0];
    xml += `
  <url>
    <loc>${DOMAIN}${item.url}</loc>
    <lastmod>${lastmod}</lastmod>
    <changefreq>${item.changefreq}</changefreq>
    <priority>${item.priority}</priority>
  </url>`;
  });

  xml += '\n</urlset>';
  return xml;
}

// Main function
function main() {
  console.log('ğŸ” Redirects Ø³Û’ URLs Ø¬Ù…Ø¹ Ú©Ø± Ø±ÛØ§ ÛÙˆÚº...');
  const urls = extractUrlsFromRedirects();
  console.log(`âœ… ${urls.length} URLs Ù…Ù„ Ú¯Ø¦ÛŒÚº`);
  
  const sitemapXml = generateSitemap(urls);
  
  // public folder Ù…ÛŒÚº sitemap.xml Ù„Ú©Ú¾ÛŒÚº
  const publicDir = path.join(__dirname, 'public');
  if (!fs.existsSync(publicDir)) {
    fs.mkdirSync(publicDir, { recursive: true });
  }
  
  fs.writeFileSync(path.join(publicDir, 'sitemap.xml'), sitemapXml);
  console.log('âœ… sitemap.xml public/ folder Ù…ÛŒÚº Ø¨Ù† Ú¯Ø¦ÛŒ ÛÛ’');
  
  // sitemap Ú©ÛŒ summary Ø¨Ú¾ÛŒ Ø¨Ù†Ø§Ø¦ÛŒÚº
  console.log('\nğŸ“Š Sitemap Summary:');
  console.log(`- Ú©Ù„ URLs: ${urls.length}`);
  console.log(`- Sitemap URL: ${DOMAIN}/sitemap.xml`);
  console.log(`- Robots.txt Ù…ÛŒÚº Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº: Sitemap: ${DOMAIN}/sitemap.xml`);
}

main();
